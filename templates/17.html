<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ML Builder - Polished</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#0f161d; --panel:#11151a; --card:#1c2228; --muted:#9aa6b2;
    --accent:#4cafef; --teal:#26A69A; --purple:#9C27B0;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,Segoe UI,Helvetica,Arial;color:#e6eef8}
  .sidebar{width:200px;background:var(--panel);position:fixed;left:0;top:0;bottom:0;padding:16px;box-sizing:border-box;border-right:1px solid #0b1014}
  .sidebar h3{margin:0 0 12px 0;color:var(--muted);font-size:13px}
  .sb-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;cursor:grab;margin-bottom:10px}
  .sb-item:hover{background:#0f212f}
  .sb-item svg{width:20px;height:20px;flex-shrink:0}
  .topbar{position:fixed;left:200px;right:0;top:0;height:56px;background:var(--card);border-bottom:1px solid #121416;display:flex;align-items:center;justify-content:flex-end;padding:0 14px;gap:8px}
  .icon-btn{background:transparent;border:0;color:#e6eef8;padding:8px;cursor:pointer;border-radius:6px}
  .canvas-wrap{position:fixed;left:200px;top:56px;right:0;bottom:0;padding:12px}
  #canvas{width:100%;height:100%;background:linear-gradient(180deg, rgba(0,0,0,0.04), transparent);border:1px dashed #132028;border-radius:10px;position:relative;overflow:hidden}
  .placeholder{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:var(--muted)}
  .block-wrapper{position:absolute;transform-origin:left top}
  .block-box{width:170px;min-height:100px;background:var(--card);border:1px solid #162025;border-radius:8px;padding:8px;display:flex;flex-direction:column;align-items:center;gap:6px;position:relative;cursor:grab}
  .block-title{font-size:13px;font-weight:bold;color:#fff;margin-bottom:6px;text-align:center}
  .neuron-strip,.square-strip{display:flex;flex-direction:column;align-items:center;gap:8px}
  .neuron{width:14px;height:14px;border:2px solid var(--accent);border-radius:50%}
  .square{width:14px;height:14px;border:2px solid var(--teal)}
  .block-extra{font-size:12px;color:#e6eef8;margin-top:6px;text-align:center}
  .connector{width:12px;height:12px;border-radius:50%;background:#1e2a35;border:2px solid var(--accent);position:absolute;cursor:crosshair}
  .connector:hover{background:#4cafef}
  .connector.left{left:2px;top:50%;transform:translateY(-50%)}
  .connector.right{right:2px;top:50%;transform:translateY(-50%)}
  svg.connections{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;overflow:visible}
  path.wire{stroke:var(--accent);stroke-width:2;fill:none;pointer-events:auto}
  path.wire:hover{stroke:#90cdf4;stroke-width:3}
</style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Blocks</h3>
    <div class="sb-item" draggable="true" data-type="data">
      <svg viewBox="0 0 24 24" fill="none" stroke="#9fb6c8" stroke-width="1.6"><ellipse cx="12" cy="5" rx="7" ry="3"/><path d="M5 5v6c0 1.7 3.1 3 7 3s7-1.3 7-3V5"/><path d="M5 11v6c0 1.7 3.1 3 7 3s7-1.3 7-3"/></svg>
      <span>Data Source</span>
    </div>
    <div class="sb-item" draggable="true" data-type="input">
      <svg viewBox="0 0 24 24" fill="none" stroke="#7ec7ff" stroke-width="1.6"><circle cx="7" cy="12" r="2"/><circle cx="12" cy="7" r="2"/><circle cx="17" cy="12" r="2"/></svg>
      <span>Input Layer</span>
    </div>
    <div class="sb-item" draggable="true" data-type="encoder">
      <svg viewBox="0 0 24 24" fill="none" stroke="#6ee7b7" stroke-width="1.6"><rect x="4" y="6" width="16" height="3" rx="1"/><rect x="6" y="11" width="12" height="3" rx="1"/></svg>
      <span>Encoder</span>
    </div>
    <div class="sb-item" draggable="true" data-type="attention">
      <svg viewBox="0 0 24 24" fill="none" stroke="#d29bff" stroke-width="1.6"><circle cx="12" cy="8" r="3"/></svg>
      <span>Attention</span>
    </div>
    <div class="sb-item" draggable="true" data-type="decoder">
      <svg viewBox="0 0 24 24" fill="none" stroke="#6ee7b7" stroke-width="1.6"><rect x="4" y="6" width="16" height="3" rx="1"/><rect x="6" y="11" width="12" height="3" rx="1"/></svg>
      <span>Decoder</span>
    </div>
    <div class="sb-item" draggable="true" data-type="output">
      <svg viewBox="0 0 24 24" fill="none" stroke="#7ec7ff" stroke-width="1.6"><circle cx="12" cy="12" r="3"/></svg>
      <span>Output</span>
    </div>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="icon-btn" id="undoBtn" title="Undo">⟲</button>
    <button class="icon-btn" id="redoBtn" title="Redo">⟳</button>
    <button class="icon-btn" id="zoomInBtn" title="Zoom In">＋</button>
    <button class="icon-btn" id="zoomOutBtn" title="Zoom Out">－</button>
  </div>

  <!-- Canvas -->
  <div class="canvas-wrap">
    <div id="canvas">
      <svg class="connections"></svg>
      <div class="placeholder" id="placeholder">Blank canvas — drag blocks here</div>
    </div>
  </div>

<script>
const canvas = document.getElementById('canvas');
const svg = canvas.querySelector('svg.connections');
const placeholder = document.getElementById('placeholder');

let model = { blocks: [], connections: [] };
let idCounter = 1;
let history = [], future = [];

function pushHistory(){ history.push(JSON.stringify(model)); if(history.length>80) history.shift(); future=[]; }
function undo(){ if(history.length>1){ future.push(history.pop()); model=JSON.parse(history[history.length-1]); render(); } }
function redo(){ if(future.length>0){ const s=future.pop(); history.push(s); model=JSON.parse(s); render(); } }
document.getElementById('undoBtn').onclick=undo;
document.getElementById('redoBtn').onclick=redo;

let zoom=1;
function setZoom(z){ zoom=z; canvas.style.transform=`scale(${zoom})`; }
document.getElementById('zoomInBtn').onclick=()=>setZoom(Math.min(2,zoom+0.1));
document.getElementById('zoomOutBtn').onclick=()=>setZoom(Math.max(0.3,zoom-0.1));

function addBlockToModel(type,x,y){
  const b={id:'b'+(idCounter++),type,x,y,neurons:128,activation:'ReLU'};
  model.blocks.push(b);
  pushHistory();
  render();
}

function removeAllRenderedBlocks(){canvas.querySelectorAll('.block-wrapper').forEach(n=>n.remove());}

function render(){
  placeholder.style.display=model.blocks.length?'none':'block';
  removeAllRenderedBlocks();
  model.blocks.forEach(b=>{
    const wrapper=document.createElement('div');
    wrapper.className='block-wrapper';
    wrapper.style.left=b.x+'px';
    wrapper.style.top=b.y+'px';
    wrapper.dataset.id=b.id;

    const box=document.createElement('div');
    box.className='block-box';

    const title=document.createElement('div');
    title.className='block-title';
    title.textContent=
      b.type==='data'?'Data Source':
      b.type==='input'?'Input Layer':
      b.type==='encoder'?'Encoder Layer':
      b.type==='decoder'?'Decoder Layer':
      b.type==='attention'?'Attention':
      b.type==='output'?'Output Layer':b.type;
    box.appendChild(title);

    if(b.type==='data'){
      const inner=document.createElement('div');
      inner.innerHTML='<strong>CSV / JSON</strong>';
      box.appendChild(inner);
    } else if(b.type==='attention'){
      const inner=document.createElement('div');
      inner.innerHTML='Query / Key / Value<br>Softmax<br>Weighted Sum';
      box.appendChild(inner);
    } else if(b.type==='input'||b.type==='output'){
      const strip=document.createElement('div'); strip.className='neuron-strip';
      for(let i=0;i<4;i++){const n=document.createElement('div'); n.className='neuron'; strip.appendChild(n);}
      box.appendChild(strip);
    } else if(b.type==='encoder'||b.type==='decoder'){
      const strip=document.createElement('div'); strip.className='square-strip';
      for(let i=0;i<4;i++){const s=document.createElement('div'); s.className='square'; strip.appendChild(s);}
      box.appendChild(strip);
    }

    if(b.type!=='data' && b.type!=='attention'){
      const extra=document.createElement('div');
      extra.className='block-extra';
      extra.innerHTML=`Neurons: <b>${b.neurons}</b><br>Activation: <b>${b.activation}</b>`;
      box.appendChild(extra);
    }

    // connectors
    if(b.type==='data'){ 
      const c=document.createElement('div'); c.className='connector right'; c.dataset.side='right'; c.dataset.block=b.id; box.appendChild(c);
    } else if(b.type==='output'){ 
      const c=document.createElement('div'); c.className='connector left'; c.dataset.side='left'; c.dataset.block=b.id; box.appendChild(c);
    } else { 
      const cl=document.createElement('div'); cl.className='connector left'; cl.dataset.side='left'; cl.dataset.block=b.id; box.appendChild(cl);
      const cr=document.createElement('div'); cr.className='connector right'; cr.dataset.side='right'; cr.dataset.block=b.id; box.appendChild(cr);
    }

    wrapper.appendChild(box);
    canvas.appendChild(wrapper);
    makeDraggable(wrapper,b.id);
  });
  redrawAllWires();
  bindConnectorEvents();
}

function makeDraggable(wrapper,blockId){
  let isDown=false,startX=0,startY=0,origX=0,origY=0;
  wrapper.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('connector')) return;
    isDown=true;
    startX=e.clientX; startY=e.clientY;
    origX=parseInt(wrapper.style.left,10); origY=parseInt(wrapper.style.top,10);
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  });
  function onMove(e){
    if(!isDown)return;
    const dx=e.clientX-startX,dy=e.clientY-startY;
    const nx=origX+dx,ny=origY+dy;
    wrapper.style.left=nx+'px'; wrapper.style.top=ny+'px';
    const blk=model.blocks.find(x=>x.id===blockId);
    if(blk){blk.x=nx;blk.y=ny; redrawAllWires();}
  }
  function onUp(e){
    isDown=false;
    document.removeEventListener('mousemove',onMove);
    document.removeEventListener('mouseup',onUp);
    pushHistory();
  }
}

// Wires
let draggingConnector=null;
function bindConnectorEvents(){
  canvas.querySelectorAll('.connector').forEach(c=>{
    c.onmousedown=e=>{
      e.stopPropagation();
      const blockId=c.dataset.block;
      const side=c.dataset.side;
      startConnectorDrag(blockId,side);
    };
  });
}
function startConnectorDrag(blockId,side){
  draggingConnector={from:{blockId,side}};
  const p=getConnectorCenter(blockId,side);
  const pth=document.createElementNS("http://www.w3.org/2000/svg","path");
  pth.setAttribute('class','wire');
  pth.setAttribute('d',`M${p.x},${p.y} C${p.x+50},${p.y} ${p.x+50},${p.y} ${p.x},${p.y}`);
  svg.appendChild(pth);
  draggingConnector.tempPath=pth;
}
canvas.addEventListener('mousemove',e=>{
  if(draggingConnector){
    const m=getMouseInCanvas(e);
    const p1=getConnectorCenter(draggingConnector.from.blockId,draggingConnector.from.side);
    draggingConnector.tempPath.setAttribute('d',`M${p1.x},${p1.y} C${p1.x+50},${p1.y} ${m.x-50},${m.y} ${m.x},${m.y}`);
  }
});
canvas.addEventListener('mouseup',e=>{
  if(draggingConnector){
    const target=document.elementFromPoint(e.clientX,e.clientY);
    if(target && target.classList && target.classList.contains('connector')){
      const toBlock=target.dataset.block; const toSide=target.dataset.side;
      if(!(draggingConnector.from.blockId===toBlock && draggingConnector.from.side===toSide)){
        model.connections.push({from:draggingConnector.from,to:{blockId:toBlock,side:toSide}});
      }
    }
    if(draggingConnector.tempPath) draggingConnector.tempPath.remove();
    draggingConnector=null;
    pushHistory(); render();
  }
});
function getConnectorCenter(blockId,side){
  const wrapper=canvas.querySelector(`.block-wrapper[data-id="${blockId}"]`);
  const conn=wrapper?wrapper.querySelector(`.connector.${side}`):null;
  const r=conn.getBoundingClientRect(); const crect=canvas.getBoundingClientRect();
  return {x:r.left+r.width/2-crect.left,y:r.top+r.height/2-crect.top};
}
function getMouseInCanvas(e){
  const crect=canvas.getBoundingClientRect();
  return {x:e.clientX-crect.left,y:e.clientY-crect.top};
}
function drawConnection(conn){
  const p1=getConnectorCenter(conn.from.blockId,conn.from.side);
  const p2=getConnectorCenter(conn.to.blockId,conn.to.side);
  const path=document.createElementNS("http://www.w3.org/2000/svg","path");
  path.setAttribute('class','wire');
  path.setAttribute('d',`M${p1.x},${p1.y} C${p1.x+50},${p1.y} ${p2.x-50},${p2.y} ${p2.x},${p2.y}`);
  svg.appendChild(path);
}
function redrawAllWires(){
  while(svg.firstChild) svg.removeChild(svg.firstChild);
  model.connections.forEach(c=> drawConnection(c));
}

document.querySelectorAll('.sb-item').forEach(it=>{
  it.addEventListener('dragstart',e=> e.dataTransfer.setData('type',it.dataset.type));
});
canvas.addEventListener('dragover',e=> e.preventDefault());
canvas.addEventListener('drop',e=>{
  e.preventDefault();
  const t=e.dataTransfer.getData('type');
  const crect=canvas.getBoundingClientRect();
  const x=e.clientX-crect.left-70;
  const y=e.clientY-crect.top-20;
  addBlockToModel(t,x,y);
});

pushHistory();
render();
</script>
</body>
</html>
